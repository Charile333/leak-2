# 方案B：将TrendRadar和中间层API一起部署在AWS上
version: '3.8'

services:
  # 中间层API服务
  backend-api:
    build:
      context: .
      dockerfile: Dockerfile.backend
    container_name: backend-api
    restart: unless-stopped
    ports:
      - "3001:3001"
    environment:
      - NODE_ENV=production
      - VITE_LEAKRADAR_API_KEY=${VITE_LEAKRADAR_API_KEY}
      - VITE_OTX_API_KEY=${VITE_OTX_API_KEY}
      - TRENDRADAR_API_URL=http://trendradar:8080
      - JWT_SECRET=${JWT_SECRET}
      - SMTP_HOST=${SMTP_HOST}
      - SMTP_PORT=${SMTP_PORT}
      - SMTP_SECURE=${SMTP_SECURE}
      - SMTP_USER=${SMTP_USER}
      - SMTP_PASS=${SMTP_PASS}
    depends_on:
      - trendradar
    networks:
      - trendradar-network

  # TrendRadar服务
  trendradar:
    image: wantcat/trendradar:latest
    container_name: trendradar
    restart: unless-stopped
    ports:
      - "8080:8080"
    volumes:
      - ./TrendRadar/config:/app/config:ro
      - ./TrendRadar/output:/app/output
    environment:
      - TZ=Asia/Shanghai
      # Web 服务器
      - ENABLE_WEBSERVER=true
      - WEBSERVER_PORT=8080
      # AI 配置（ai_analysis 和 ai_translation 共享模型配置）
      - AI_ANALYSIS_ENABLED=true
      - AI_API_KEY=${AI_API_KEY}
      - AI_MODEL=${AI_MODEL}
      - AI_API_BASE=${AI_API_BASE}
      # 运行模式
      - CRON_SCHEDULE=*/30 * * * *
      - RUN_MODE=cron
      - IMMEDIATE_RUN=true
    networks:
      - trendradar-network

networks:
  trendradar-network:
    driver: bridge
